<script>
document.addEventListener('DOMContentLoaded', () => {
  // === DATA ===
  const PARISH_TOWNS = {
    "clarendon": "May Pen", "hanover": "Lucea", "kingston": "Kingston", "manchester": "Mandeville",
    "portland": "Port Antonio", "saint-andrew": "Half Way Tree", "saint-ann": "St. Ann’s Bay",
    "saint-catherine": "Spanish Town", "saint-elizabeth": "Black River", "saint-james": "Montego Bay",
    "saint-mary": "Port Maria", "saint-thomas": "Morant Bay", "trelawny": "Falmouth",
    "westmoreland": "Savanna-la-Mar"
  };
  const ALL_PARISHES = Object.keys(PARISH_TOWNS);

  const LIVE_DATA = { /* ... your full LIVE_DATA object ... */ };

  // === STATE ===
  let state = { 
    from:'', arrive:'', depart:'', parish:'', vibe:'', stay:null, 
    transport:[], tours:[], nights:1, adults:2, kids:0, isLocal:false, flight:null 
  };
  let total = 0;
  let tonConnectUI;
  let currentStep = 0;
  const totalSteps = 9;

  // === TON CONNECT ===
  try {
    tonConnectUI = new window.TonConnectUI({
      manifestUrl: 'https://yaadvibe.com/tonconnect-manifest.json',
      buttonRootId: null
    });
  } catch(e) { console.warn("TON Connect not loaded"); }

  // === CORE FUNCTIONS ===
  const updateCalc = (animate = false) => {
    const prevTotal = total;
    total = 0;
    if (state.stay) {
      const base = state.stay.price * state.nights;
      const occupancyFee = state.adults > 2 ? (state.adults - 2) * 50 : 0;
      total += base + occupancyFee + Math.round(base * 0.05);
    }
    state.transport.forEach(t => total += t.price);
    state.tours.forEach(t => total += t.price);
    if (state.flight) total += state.flight.price;

    const el = document.getElementById('liveTotal');
    el.textContent = total.toFixed(2);
    if (animate && total !== prevTotal) {
      el.parentElement.classList.add('animate');
      setTimeout(() => el.parentElement.classList.remove('animate'), 600);
    }
  };

  const calcNightsFromDates = () => {
    const arrive = document.getElementById('arriveDate').value;
    const depart = document.getElementById('departDate').value;
    if (arrive && depart) {
      const diff = (new Date(depart) - new Date(arrive)) / 86400000;
      if (diff > 0) {
        state.nights = diff;
        document.getElementById('nightCount').textContent = diff;
        updateCalc(true);
      }
    }
  };

  const renderParishes = () => {
    const c = document.getElementById('parish-options'); c.innerHTML = '';
    ALL_PARISHES.forEach(p => {
      const display = `${p.replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase())} (${PARISH_TOWNS[p]})`;
      const card = document.createElement('div');
      card.className = 'option-card';
      card.innerHTML = `<div class="info"><div class="name">${display}</div></div>`;
      card.onclick = () => {
        c.querySelectorAll('.option-card').forEach(x => x.classList.remove('selected'));
        card.classList.add('selected');
        state.parish = p;
        document.getElementById('parishNext').style.display = 'block';
      };
      c.appendChild(card);
    });
  };

  const loadStays = () => {
    const c = document.getElementById('stay-options');
    c.innerHTML = '<p style="text-align:center;color:#aaa">Finding your vibe...</p>';
    setTimeout(() => {
      c.innerHTML = '';
      const items = LIVE_DATA.accommodations[state.parish] || LIVE_DATA.accommodations.default;
      const filtered = state.vibe ? items.filter(i => i.type === state.vibe) : items;
      filtered.forEach(item => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.innerHTML = `
          <img src="${item.img}" onerror="this.src='/IMG_0039.jpeg'" alt="${item.name}">
          <div class="info">
            <div class="name">${item.name}</div>
            <div class="price">$${item.price}${item.source === 'Tour' ? '' : '/night'}</div>
          </div>
        `;
        card.onclick = () => {
          c.querySelectorAll('.option-card').forEach(x => x.classList.remove('selected'));
          card.classList.add('selected');
          state.stay = {...item, fee: Math.round(item.price * 0.05)};
          updateCalc(true);
        };
        c.appendChild(card);
      });
    }, 600);
  };

  const loadTransport = () => {
    const c = document.getElementById('transport-options'); c.innerHTML = '';
    const opts = LIVE_DATA.transport[state.parish] || LIVE_DATA.transport.default;
    opts.forEach(t => {
      const card = document.createElement('div');
      card.className = 'option-card';
      card.innerHTML = `<div class="info"><div class="name">${t.name}</div><div class="price">$${t.price}</div></div>`;
      card.onclick = () => {
        card.classList.toggle('selected');
        if (card.classList.contains('selected')) state.transport.push(t);
        else state.transport = state.transport.filter(x => x.name !== t.name);
        updateCalc(true);
      };
      c.appendChild(card);
    });
  };

  const loadTours = () => {
    const c = document.getElementById('tour-options'); c.innerHTML = '';
    const opts = LIVE_DATA.tours[state.parish] || LIVE_DATA.tours.default;
    opts.forEach(t => {
      const card = document.createElement('div');
      card.className = 'option-card';
      card.innerHTML = `<div class="info"><div class="name">${t.name}</div><div class="price">$${t.price}</div></div>`;
      card.onclick = () => {
        card.classList.toggle('selected');
        if (card.classList.contains('selected')) state.tours.push(t);
        else state.tours = state.tours.filter(x => x.name !== t.name);
        updateCalc(true);
      };
      c.appendChild(card);
    });
  };

  const loadFlights = () => {
    const c = document.getElementById('flight-options'); c.innerHTML = '';
    const opts = LIVE_DATA.flights[state.from] || LIVE_DATA.flights.default;
    opts.forEach(f => {
      const card = document.createElement('div');
      card.className = 'option-card';
      card.innerHTML = `
        <div class="info">
          <div class="name">${f.airline} • ${f.code}</div>
          <div class="price">$${f.price} roundtrip</div>
        </div>
      `;
      card.onclick = () => {
        document.querySelectorAll('#flight-options .option-card').forEach(x => x.classList.remove('selected'));
        card.classList.add('selected');
        state.flight = f;
      };
      c.appendChild(card);
    });
  };

  const showSummary = () => {
    const div = document.getElementById('summary-items'); div.innerHTML = '';
    const add = (label, price, fee = 0) => {
      div.innerHTML += `<div class="item"><span>${label}</span><span>$${price}${fee ? ` + <strong>$${fee}</strong> fee` : ''}</span></div>`;
    };
    if (state.stay) {
      const base = state.stay.price * state.nights;
      const occupancyFee = state.adults > 2 ? (state.adults - 2) * 50 : 0;
      add(`${state.stay.name} (${state.nights} nights, ${state.adults}A/${state.kids}K)`, base + occupancyFee, Math.round(base * 0.05));
    }
    state.transport.forEach(t => add(t.name, t.price));
    state.tours.forEach(t => add(t.name, t.price));
    if (state.flight) add(`${state.flight.airline} Flight`, state.flight.price);
    document.getElementById('total').textContent = total.toFixed(2);
    next(9);
  };

  // === NAVIGATION ===
  const next = n => {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    const id = n === 9 ? 'summary' : n === 2.5 ? 'step25' : 'step' + n;
    const target = document.getElementById(id);
    if (target) {
      target.classList.add('active');
      currentStep = n;
      updateProgress();
      updateCalc(true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const goBack = () => {
    if (currentStep > 0) {
      const prev = currentStep === 2.5 ? 2 : Math.floor(currentStep) - 1;
      next(prev);
    }
  };

  // === PROGRESS ===
  const PROGRESS_ICONS = ['Flag', 'Plane', 'Calendar', 'Map', 'Palm Tree', 'Hotel', 'Car', 'Star', 'Wallet'];
  const updateProgress = () => {
    const prog = document.getElementById('progress'); prog.innerHTML = '';
    PROGRESS_ICONS.forEach((icon, i) => {
      const span = document.createElement('span');
      span.className = 'prog-icon';
      span.textContent = icon;
      const stepIndex = currentStep === 0 ? 0 :
                       (currentStep === 2 || currentStep === 2.5) ? 1 :
                       Math.min(Math.floor(currentStep) - 1, 8);
      if (i === stepIndex) span.classList.add('active');
      if (i < stepIndex) span.classList.add('done');
      prog.appendChild(span);
    });
  };

  // === EVENT LISTENERS ===
  document.getElementById('startBtn').addEventListener('click', () => {
    next(1);
    setTimeout(() => document.querySelector('#step1 .option-card[data-value="yes"]')?.click(), 200);
  });

  document.getElementById('step1').addEventListener('click', e => {
    const card = e.target.closest('.option-card');
    if (!card) return;
    document.querySelectorAll('#step1 .option-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    state.isLocal = card.dataset.value === 'no';
    setTimeout(() => {
      next(2);
      if (state.isLocal) setTimeout(renderParishes, 100);
    }, 150);
  });

  document.getElementById('btn2').onclick = () => {
    state.from = document.getElementById('fromCity').value;
    if (!state.from) return alert("Choose your city!");
    if (!state.isLocal) { loadFlights(); next(2.5); } else { next(3); }
  };

  document.getElementById('step25').addEventListener('click', e => {
    const card = e.target.closest('.option-card[data-flight="skip"]');
    if (card) {
      document.querySelectorAll('#step25 .option-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.flight = null;
    }
  });

  document.getElementById('btnFlight').onclick = () => {
    const sel = document.querySelector('#flight-options .option-card.selected');
    if (!sel && !state.flight) return alert("Choose a flight or skip");
    if (state.flight) {
      document.getElementById('arriveDate').value = state.flight.arrive;
      document.getElementById('departDate').value = state.flight.depart;
      calcNightsFromDates();
    }
    next(3);
  };

  document.getElementById('step5').addEventListener('click', e => {
    const card = e.target.closest('.option-card');
    if (card) {
      document.querySelectorAll('#step5 .option-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
    }
  });

  document.getElementById('btnVibe').onclick = () => {
    const sel = document.querySelector('#step5 .option-card.selected');
    if (!sel) return alert("Choose vibe!");
    state.vibe = sel.dataset.value;
    loadStays();
    next(6);
  };

  ['adults','kids'].forEach(id => {
    document.getElementById(id).onchange = e => { state[id] = +e.target.value; updateCalc(true); };
  });

  document.getElementById('minus').onclick = () => { if (state.nights > 1) { state.nights--; document.getElementById('nightCount').textContent = state.nights; updateCalc(true); } };
  document.getElementById('plus').onclick = () => { state.nights++; document.getElementById('nightCount').textContent = state.nights; updateCalc(true); };
  document.getElementById('departDate').addEventListener('change', calcNightsFromDates);

  document.getElementById('btn3').onclick = () => {
    state.arrive = document.getElementById('arriveDate').value;
    state.depart = document.getElementById('departDate').value;
    if (!state.arrive || !state.depart) return alert("Pick both dates!");
    next(4);
    renderParishes();
  };

  document.getElementById('parishNext').onclick = () => {
    if (!state.parish) return alert("Choose parish!");
    next(5);
  };

  document.getElementById('btnStay').onclick = () => {
    if (!state.stay) return alert("Pick stay!");
    loadTransport();
    next(7);
  };

  document.getElementById('btnTransport').onclick = () => { loadTours(); next(8); };
  document.getElementById('btnTours').onclick = showSummary;

  document.querySelectorAll('.btn.back').forEach(btn => btn.onclick = goBack);

  // === PAYMENT ===
  document.getElementById('btnPay').onclick = async () => {
    if (total === 0) return alert("Add items first!");
    if (!tonConnectUI) return alert("TON Wallet not available");

    const finalTotal = total;
    const payload = { ...state, total: finalTotal };

    try {
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c",
          amount: String(Math.round(finalTotal * 1e9)),
          payload: btoa(JSON.stringify(payload))
        }]
      };
      const result = await tonConnectUI.sendTransaction(tx);
      alert(`Payment sent! Total: $${finalTotal.toFixed(2)}\nTx: ${result.boc}`);
      new QRCode(document.getElementById("qr-area"), {
        text: result.boc, width: 240, height: 240,
        colorDark: "#FFD700", colorLight: "#000"
      });
    } catch (e) {
      alert("Payment failed: " + e.message);
    }
  };

  // === INIT ===
  updateProgress();
});
</script>
